# Copyright (c) 2019 Shotgun Software Inc.
#
# CONFIDENTIAL AND PROPRIETARY
#
# This work is provided "AS IS" and subject to the Shotgun Pipeline Toolkit
# Source Code License included in this distribution package. See LICENSE.
# By accessing, using, copying or modifying this work you indicate your
# agreement to the Shotgun Pipeline Toolkit Source Code License. All rights
# not expressly granted therein are reserved by Shotgun Software Inc.

parameters:
  # Version of tk-toolchain to use.
  tk_toolchain_ref: master
  # Version of the release repository to use.
  # This is meant for deployment to the Toolkit AppStore. This repository is private
  # to the Shotgun team and cannot be accessed by external organizations. This is meant
  # for internal use by the team for testing and should not be modified otherwise.
  release_repo_ref: master

jobs:
- job: release_toolkit_bundle
  displayName: Release Toolkit bundle
  pool:
    vmImage: ubuntu-latest
  steps:
    # Switch to the right Python Version.
    - task: UsePythonVersion@0
      inputs:
        versionSpec: 3.10
      displayName: Use Python 3.10

    # Validate Git tag version format using inline Python script
    # This is the source of truth for the validation logic
    - task: PythonScript@0
      displayName: Validate Git tag version format
      inputs:
        scriptSource: inline
        script: |
          import os
          import re

          def validate(version: str) -> bool:
              return (
                  re.match(
                      r"^v\d+\.\d+\.\d+(-[\w\d-]+)?$",
                      version,
                  )
                  is not None
              )

          if __name__ == "__main__":
              git_ref = os.environ["BUILD_SOURCEBRANCH"]
              assert git_ref.startswith("refs/tags/"), f"Expected tag ref, got: {git_ref}"
              version = git_ref[10:]
              assert validate(version), f"Invalid version format: {version}"
              print(f"âœ“ Valid version format: {version}")

    - template: configure-git.yml

    # Pushes the bundle to the appstore.
    - template: release-to-appstore.yml
      parameters:
        release_repo_ref: ${{ parameters.release_repo_ref }}

    # We need tk-toolchain to use update-configurations.yml
    - template: pip-install-packages.yml
      parameters:
        packages:
        - https://github.com/shotgunsoftware/tk-toolchain/archive/${{ parameters.tk_toolchain_ref }}.zip

    # Updates the basic, default2 and flame configs
    - template: "update-configuration.yml"
      parameters:
        name: tk-config-basic

    - template: "update-configuration.yml"
      parameters:
        name: tk-config-default2

    - template: "update-configuration.yml"
      parameters:
        name: tk-config-flameplugin

    - template: "update-configuration.yml"
      parameters:
        name: tk-config-rv
