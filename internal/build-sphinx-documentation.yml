# Copyright (c) 2025 Shotgun Software Inc.
#
# CONFIDENTIAL AND PROPRIETARY
#
# This work is provided "AS IS" and subject to the Shotgun Pipeline Toolkit
# Source Code License included in this distribution package. See LICENSE.
# By accessing, using, copying or modifying this work you indicate your
# agreement to the Shotgun Pipeline Toolkit Source Code License. All rights
# not expressly granted therein are reserved by Shotgun Software Inc.

parameters:
  # Git ref of tk-toolchain to use.
  tk_toolchain_ref: ticket/SG-41463
  # Git ref of tk-core to use.
  tk_core_ref: master

jobs:
# Spin up a Linux VM for validating code.
- job: build_documentation
  displayName: Build Sphinx Documentation
  pool:
    vmImage: ubuntu-latest

  steps:
  - task: Bash@3
    displayName: Detect if the documentation folder exists
    inputs:
      targetType: inline
      script: |
        if [ -d "$(Build.SourcesDirectory)/resources" ]; then
          has_docs="true"
        else
          has_docs="false"
        fi

        echo "##vso[task.setvariable variable=has_docs]${has_docs}"

  - task: Bash@3
    condition: eq( variables['has_docs'], false )
    displayName: Skip building documentation since does not exists
    inputs:
      targetType: inline
      script: env

  - task: UsePythonVersion@0
    condition: eq( variables['has_docs'], true )
    displayName: Use Python 3.10
    inputs:
      versionSpec: "3.10"

  - template: pip-install-packages.yml
    condition: eq( variables['has_docs'], true )
    parameters:
      packages:
      - ${{ if startsWith( variables['Build.SourceBranch'], 'tk-' ) }}:
        - PySide2
      - https://github.com/shotgunsoftware/tk-toolchain/archive/${{ parameters.tk_toolchain_ref }}.zip

  - ${{ if startsWith( variables['Build.SourceBranch'], 'tk-' ) }}:
    - template: clone-repositories.yml
      condition: eq( variables['has_docs'], true )
      parameters:
        repositories:
        - name: tk-core
          ref: ${{ parameters.tk_core_ref }}

  - task: Bash@3
    condition: eq( variables['has_docs'], true )
    displayName: Build Shpinx Documentation
    inputs:
      targetType: inline
      script: tk-docs-preview --build-only --verbose
