# Copyright (c) 2019 Shotgun Software Inc.
#
# CONFIDENTIAL AND PROPRIETARY
#
# This work is provided "AS IS" and subject to the Shotgun Pipeline Toolkit
# Source Code License included in this distribution package. See LICENSE.
# By accessing, using, copying or modifying this work you indicate your
# agreement to the Shotgun Pipeline Toolkit Source Code License. All rights
# not expressly granted therein are reserved by Shotgun Software Inc.

parameters:
    release_repo_ref: master

steps:
- task: Bash@3
  displayName: Install the release scripts
  env:
    GH_ACCESS_TOKEN: $(GITHUB_ACCESS_TOKEN)
    RELEASE_REPO: $(repo.release)
  inputs:
    targetType: inline
    script: |
        git clone --depth 1 "https://github.com/${RELEASE_REPO}" --branch ${{ parameters.release_repo_ref }}  ../release_scripts

- task: Bash@3
  displayName: Prepare release script
  inputs:
    targetType: inline
    script: |
        pip install -r ../release_scripts/app_store/requirements.txt
    # We don't need to call the internal script's prepare_repo.sh since we will be stating with a fresh environment each time
    # which is setup by Azure. So just clone the repo and install the requirements.

- task: PythonScript@0
  displayName: Detect bundle type
  # By looking at the python file at the root of the repo
  inputs:
    scriptSource: inline
    script: |
        import os
        if os.path.exists("app.py"):
            bundle_type = "app"
        elif os.path.exists("framework.py"):
            bundle_type = "framework"
        elif os.path.exists("engine.py"):
            bundle_type = "engine"
        else:
            bundle_type = "config"

        # Expose the variable to the Azure Pipeline environment
        print(f"##vso[task.setvariable variable=BUNDLE_TYPE]{bundle_type}")
