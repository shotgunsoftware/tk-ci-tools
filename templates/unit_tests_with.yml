# Copyright (c) 2019 Shotgun Software Inc.
#
# CONFIDENTIAL AND PROPRIETARY
#
# This work is provided "AS IS" and subject to the Shotgun Pipeline Toolkit
# Source Code License included in this distribution package. See LICENSE.
# By accessing, using, copying or modifying this work you indicate your
# agreement to the Shotgun Pipeline Toolkit Source Code License. All rights
# not expressly granted therein are reserved by Shotgun Software Inc.

parameters:
  qt_wrapper: PySide2
  python_version: 3.7
  extra_pip_dependencies: ""

steps:

- bash: git clone https://github.com/shotgunsoftware/tk-core --depth 1 --branch SG-13264-python-3-compat ../tk-core
  displayName: Installing Toolkit Dependencies

- task: UsePythonVersion@0
  inputs:
    versionSpec: ${{ parameters.python_version }}
  displayName: Use Python ${{ parameters.python_version }}

- bash: |
    pip install ${{ parameters.qt_wrapper }} &&
    pip install git+https://github.com/shotgunsoftware/tk-toolchain.git@remote_pip_install#egg=tk-toolchain &&
    pip install pytest-azurepipelines ${{ parameters.extra_pip_dependencies }}
  displayName: Installing Python modules

- bash: |
    /usr/bin/Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
    echo ">>> Started xvfb"
  displayName: Start xvfb on Linux
  condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))

- bash: python -m pytest tests
  environment:
    QT_QPA_PLATFORM: offscreen
    DISPLAY: ':99.0'
  displayName: Running tests
